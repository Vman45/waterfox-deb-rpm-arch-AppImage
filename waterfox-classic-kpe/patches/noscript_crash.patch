From 04d7f7a73020d11831d1042085ad0e72c02865d8 Mon Sep 17 00:00:00 2001
From: Olli Pettay <Olli.Pettay@helsinki.fi>
Date: Thu, 8 Mar 2018 16:59:25 +0900
Subject: [PATCH] Bug 1443746, ensure DOM events aren't dispatched at
 unexpected time, r=masayuki

---
 dom/events/EventDispatcher.cpp | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/dom/events/EventDispatcher.cpp b/dom/events/EventDispatcher.cpp
index 2e8937c607e6..08c7d0332796 100644
--- a/dom/events/EventDispatcher.cpp
+++ b/dom/events/EventDispatcher.cpp
@@ -606,6 +606,8 @@ EventDispatcher::Dispatch(nsISupports* aTarget,
   // Events shall not be fired while we are in stable state to prevent anything
   // visible from the scripts.
   MOZ_ASSERT(!nsContentUtils::IsInStableOrMetaStableState());
+  NS_ENSURE_TRUE(!nsContentUtils::IsInStableOrMetaStableState(),
+                 NS_ERROR_DOM_INVALID_STATE_ERR);
 
 #ifdef MOZ_TASK_TRACER
   if (MOZ_UNLIKELY(mozilla::tasktracer::IsStartLogging())) {
